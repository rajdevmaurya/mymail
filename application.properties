src/main/resources/application.yml

server.error.include-exception=false
server.error.include-stacktrace=never
server.error.include-message=never
server.error.include-binding-errors=never


src/main/resources/log4j2-spring.xml

<?xml version="1.0" encoding="UTF-8"?>
<Configuration status="WARN">
  <Appenders>
    <Console name="Console" target="SYSTEM_OUT">
      <PatternLayout pattern="%d{ISO8601} [%t] %-5level %logger{36} - %msg%n"/>
    </Console>

    <RollingFile name="File" fileName="logs/app.log" filePattern="logs/app-%d{yyyy-MM-dd}.log">
      <PatternLayout pattern="%d{ISO8601} [%t] %-5level %logger{36} - %msg%n"/>
      <Policies><TimeBasedTriggeringPolicy /></Policies>
    </RollingFile>
  </Appenders>

  <Loggers>
    <Root level="info">
      <AppenderRef ref="Console"/>
      <AppenderRef ref="File"/>
    </Root>

    <Logger name="com.example" level="debug" additivity="false">
      <AppenderRef ref="Console"/>
      <AppenderRef ref="File"/>
    </Logger>
  </Loggers>
</Configuration>


src/main/java/com/example/exception/ApiError.java
import com.fasterxml.jackson.annotation.JsonInclude;
import java.time.Instant;
import java.util.List;

@JsonInclude(JsonInclude.Include.NON_NULL)
public class ApiError {

    private final Instant timestamp = Instant.now();
    private final int status;
    private final String error;
    private final String message;
    private final String path;
    private final List<String> details;

    public ApiError(int status, String error, String message, String path, List<String> details) {
        this.status = status;
        this.error = error;
        this.message = message;
        this.path = path;
        this.details = details;
    }

    public ApiError(int status, String error, String message, String path) {
        this(status, error, message, path, null);
    }

    public Instant getTimestamp() { return timestamp; }
    public int getStatus() { return status; }
    public String getError() { return error; }
    public String getMessage() { return message; }
    public String getPath() { return path; }
    public List<String> getDetails() { return details; }
}

src/main/java/com/example/exception/ResourceNotFoundException.java

public class ResourceNotFoundException extends RuntimeException {
    public ResourceNotFoundException(String msg) {
        super(msg);
    }
}

src/main/java/com/example/exception/BadRequestException.java

public class BadRequestException extends RuntimeException {
    public BadRequestException(String msg) {
        super(msg);
    }
}

src/main/java/com/example/exception/GlobalExceptionHandler.java

import jakarta.validation.ConstraintViolationException;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.http.converter.HttpMessageNotReadableException;
import org.springframework.validation.FieldError;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;
import org.springframework.web.context.request.ServletWebRequest;
import org.springframework.web.context.request.WebRequest;

import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@RestControllerAdvice(basePackages = "com.uba.f35.entitlements")
public class GlobalExceptionHandler {

    private String extractPath(WebRequest request) {
        return request instanceof ServletWebRequest
                ? ((ServletWebRequest) request).getRequest().getRequestURI()
                : "unknown";
    }

    private String format(FieldError fe) {
        return fe.getField() + ": " + fe.getDefaultMessage();
    }

    // Not found
    @ExceptionHandler(ResourceNotFoundException.class)
    public ResponseEntity<ApiError> handleNotFound(ResourceNotFoundException ex, WebRequest req) {
        log.warn("Not found: {}", ex.getMessage());
        ApiError err = new ApiError(
                HttpStatus.NOT_FOUND.value(),
                HttpStatus.NOT_FOUND.getReasonPhrase(),
                ex.getMessage(),
                extractPath(req)
        );
        return ResponseEntity.status(HttpStatus.NOT_FOUND).body(err);
    }

    // Bad request
    @ExceptionHandler(BadRequestException.class)
    public ResponseEntity<ApiError> handleBadRequest(BadRequestException ex, WebRequest req) {
        log.warn("Bad request: {}", ex.getMessage());
        ApiError err = new ApiError(
                HttpStatus.BAD_REQUEST.value(),
                HttpStatus.BAD_REQUEST.getReasonPhrase(),
                ex.getMessage(),
                extractPath(req)
        );
        return ResponseEntity.badRequest().body(err);
    }

    // JSON parse errors
    @ExceptionHandler(HttpMessageNotReadableException.class)
    public ResponseEntity<ApiError> handleJsonParse(HttpMessageNotReadableException ex, WebRequest req) {
        log.warn("Malformed JSON: {}", ex.getMessage());
        ApiError err = new ApiError(
                HttpStatus.BAD_REQUEST.value(),
                "MALFORMED_JSON",
                "Request body is malformed",
                extractPath(req)
        );
        return ResponseEntity.badRequest().body(err);
    }

    // @Valid errors
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<ApiError> handleValidation(MethodArgumentNotValidException ex, WebRequest req) {

        List<String> details = ex.getBindingResult()
                .getFieldErrors()
                .stream()
                .map(this::format)
                .collect(Collectors.toList());

        ApiError err = new ApiError(
                HttpStatus.BAD_REQUEST.value(),
                "VALIDATION_ERROR",
                "Validation failed",
                extractPath(req),
                details
        );

        log.warn("Validation failed: {}", details);
        return ResponseEntity.badRequest().body(err);
    }

    // Constraint violations (query params, path variables)
    @ExceptionHandler(ConstraintViolationException.class)
    public ResponseEntity<ApiError> handleConstraint(ConstraintViolationException ex, WebRequest req) {

        List<String> details = ex.getConstraintViolations()
                .stream()
                .map(v -> v.getPropertyPath() + ": " + v.getMessage())
                .collect(Collectors.toList());

        ApiError err = new ApiError(
                HttpStatus.BAD_REQUEST.value(),
                "CONSTRAINT_VIOLATION",
                "Invalid request parameters",
                extractPath(req),
                details
        );

        log.warn("Constraint violation: {}", details);
        return ResponseEntity.badRequest().body(err);
    }

    // Fallback
    @ExceptionHandler(Exception.class)
    public ResponseEntity<ApiError> handleAll(Exception ex, WebRequest req) {
        log.error("Unexpected error", ex);

        ApiError err = new ApiError(
                HttpStatus.INTERNAL_SERVER_ERROR.value(),
                "INTERNAL_SERVER_ERROR",
                "An unexpected error occurred",
                extractPath(req)
        );

        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(err);
    }
}

OpenAPI 3.x Error Specification (copy/paste ready)

components:
  schemas:
    ApiError:
      type: object
      description: Standard API error response.
      properties:
        timestamp:
          type: string
          format: date-time
          example: "2025-01-15T10:51:22.123Z"
        status:
          type: integer
          example: 404
        error:
          type: string
          example: "NOT_FOUND"
        message:
          type: string
          example: "User not found with id: 123"
        path:
          type: string
          example: "/api/users/123"
        details:
          type: array
          items:
            type: string

    ValidationError:
      allOf:
        - $ref: '#/components/schemas/ApiError'
      description: Validation-specific error details (details array contains field-level messages).

  responses:
    BadRequestResponse:
      description: Bad request (validation failed or malformed payload)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationError'
    NotFoundResponse:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ApiError'
    InternalServerErrorResponse:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ApiError'

'400':
  $ref: '#/components/responses/BadRequestResponse'
'404':
  $ref: '#/components/responses/NotFoundResponse'
'500':
  $ref: '#/components/responses/InternalServerErrorResponse'
